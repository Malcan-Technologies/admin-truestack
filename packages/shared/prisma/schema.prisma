// TrueIdentity Admin - Prisma Schema
// This schema mirrors the existing database structure

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// BetterAuth Tables (Admin Users)
// ============================================

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false) @map("email_verified")
  image         String?
  role          String    @default("ops") // super_admin, ops, finance
  banned        Boolean   @default(false)
  banReason     String?   @map("ban_reason")
  banExpires    DateTime? @map("ban_expires")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  sessions              Session[]
  accounts              Account[]
  clientsCreated        Client[]           @relation("ClientCreatedBy")
  apiKeysCreated        ClientApiKey[]     @relation("ApiKeyCreatedBy")
  apiKeysRevoked        ClientApiKey[]     @relation("ApiKeyRevokedBy")
  creditLedgerEntries   CreditLedger[]
  invoicesGenerated     Invoice[]          @relation("InvoiceGeneratedBy")
  paymentsRecorded      Payment[]          @relation("PaymentRecordedBy")

  @@map("user")
}

model Session {
  id        String   @id
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("session")
}

model Account {
  id                   String    @id
  userId               String    @map("user_id")
  accountId            String    @map("account_id")
  providerId           String    @map("provider_id")
  accessToken          String?   @map("access_token")
  refreshToken         String?   @map("refresh_token")
  accessTokenExpiresAt DateTime? @map("access_token_expires_at")
  refreshTokenExpiresAt DateTime? @map("refresh_token_expires_at")
  scope                String?
  idToken              String?   @map("id_token")
  password             String?   // hashed password
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([identifier])
  @@map("verification")
}

// ============================================
// Products Table
// ============================================

model Product {
  id          String   @id // 'true_identity', 'true_payments', etc.
  name        String
  description String?
  keyPrefix   String   @unique @map("key_prefix") // 'ti' for TrueIdentity
  status      String   @default("active")
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  clientApiKeys        ClientApiKey[]
  clientProductConfigs ClientProductConfig[]
  creditLedgerEntries  CreditLedger[]
  pricingTiers         PricingTier[]

  @@map("product")
}

// ============================================
// Clients (B2B Customers)
// ============================================

model Client {
  id                  String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String
  code                String   @unique // e.g., 'ACME'
  contactEmail        String?  @map("contact_email")
  contactPhone        String?  @map("contact_phone")
  companyRegistration String?  @map("company_registration") // SSM number
  status              String   @default("active") // active, suspended
  notes               String?
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @default(now()) @updatedAt @map("updated_at")
  createdBy           String?  @map("created_by")

  // Relations
  createdByUser        User?                 @relation("ClientCreatedBy", fields: [createdBy], references: [id])
  apiKeys              ClientApiKey[]
  productConfigs       ClientProductConfig[]
  creditLedgerEntries  CreditLedger[]
  kycSessions          KycSession[]
  pricingTiers         PricingTier[]
  invoices             Invoice[]
  payments             Payment[]

  @@index([code])
  @@index([status])
  @@map("client")
}

// ============================================
// Client API Keys
// ============================================

model ClientApiKey {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId        String    @map("client_id") @db.Uuid
  productId       String    @map("product_id")
  apiKeyHash      String    @map("api_key_hash") // SHA256 hash
  apiKeyEncrypted String    @map("api_key_encrypted") // AES-GCM encrypted
  apiKeyPrefix    String    @map("api_key_prefix") // 'ti_live_abc1'
  apiKeySuffix    String    @map("api_key_suffix") // last 4 chars
  environment     String    @default("live") // 'live' or 'test'
  status          String    @default("active") // active, revoked
  revokedAt       DateTime? @map("revoked_at")
  revokedBy       String?   @map("revoked_by")
  createdAt       DateTime  @default(now()) @map("created_at")
  createdBy       String?   @map("created_by")

  // Relations
  client        Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product       Product @relation(fields: [productId], references: [id])
  createdByUser User?   @relation("ApiKeyCreatedBy", fields: [createdBy], references: [id])
  revokedByUser User?   @relation("ApiKeyRevokedBy", fields: [revokedBy], references: [id])

  // Note: The partial unique index (WHERE status = 'active') is managed in raw SQL
  // Prisma doesn't support partial indexes, so we handle this at application level
  @@index([clientId])
  @@index([apiKeyHash])
  @@index([apiKeyPrefix])
  @@map("client_api_key")
}

// ============================================
// Client Product Settings
// ============================================

model ClientProductConfig {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId       String   @map("client_id") @db.Uuid
  productId      String   @map("product_id")
  enabled        Boolean  @default(true)
  webhookUrl     String?  @map("webhook_url")
  successUrl     String?  @map("success_url")
  failUrl        String?  @map("fail_url")
  allowOverdraft Boolean  @default(false) @map("allow_overdraft")
  settings       Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([clientId, productId])
  @@index([clientId, productId])
  @@map("client_product_config")
}

// ============================================
// Credit Ledger
// ============================================

model CreditLedger {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId     String   @map("client_id") @db.Uuid
  productId    String   @map("product_id")
  amount       Int      // positive = credit, negative = debit
  balanceAfter Int      @map("balance_after")
  type         String   // topup, usage, adjustment, refund
  referenceId  String?  @map("reference_id") @db.Uuid // kyc_session_id for usage
  description  String?
  createdAt    DateTime @default(now()) @map("created_at")
  createdBy    String?  @map("created_by")

  // Relations
  client        Client  @relation(fields: [clientId], references: [id])
  product       Product @relation(fields: [productId], references: [id])
  createdByUser User?   @relation(fields: [createdBy], references: [id])

  @@index([clientId, productId])
  @@index([createdAt])
  @@map("credit_ledger")
}

// ============================================
// KYC Sessions
// ============================================

model KycSession {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId             String    @map("client_id") @db.Uuid
  refId                String    @unique @map("ref_id")
  innovatifRefId       String?   @map("innovatif_ref_id") // Prefixed ref_id from Innovatif (use for get-status API)
  innovatifOnboardingId String?  @map("innovatif_onboarding_id")
  status               String    @default("pending") // pending, processing, completed, expired
  result               String?   // approved, rejected, null
  rejectMessage        String?   @map("reject_message")
  documentName         String    @map("document_name")
  documentNumber       String    @map("document_number")
  documentType         String    @default("1") @map("document_type") // 1=MyKad
  platform             String    @default("Web")
  successUrl           String?   @map("success_url")
  failUrl              String?   @map("fail_url")
  webhookUrl           String?   @map("webhook_url") // Per-session webhook override
  redirectUrl          String?   @map("redirect_url") // Client's custom redirect URL after KYC completion
  metadata             Json      @default("{}")
  innovatifResponse    Json?     @map("innovatif_response")
  s3FrontDocument      String?   @map("s3_front_document")
  s3BackDocument       String?   @map("s3_back_document")
  s3FaceImage          String?   @map("s3_face_image")
  s3BestFrame          String?   @map("s3_best_frame")
  webhookDelivered     Boolean   @default(false) @map("webhook_delivered")
  webhookDeliveredAt   DateTime? @map("webhook_delivered_at")
  webhookAttempts      Int       @default(0) @map("webhook_attempts")
  webhookLastError     String?   @map("webhook_last_error")
  billed               Boolean   @default(false) // true when credit has been deducted for this session
  billedAt             DateTime? @map("billed_at") // immutable timestamp when billing occurred, used for tiering
  expiresAt            DateTime? @map("expires_at")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  client      Client       @relation(fields: [clientId], references: [id])
  webhookLogs WebhookLog[]

  @@index([clientId])
  @@index([refId])
  @@index([innovatifOnboardingId])
  @@index([status])
  @@index([createdAt])
  @@index([billedAt])
  @@map("kyc_session")
}

// ============================================
// Webhook Delivery Log
// ============================================

model WebhookLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  kycSessionId String   @map("kyc_session_id") @db.Uuid
  source       String   // innovatif_callback, manual_retry
  payloadHash  String   @unique @map("payload_hash") // SHA256 for deduplication
  processed    Boolean  @default(false)
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  kycSession KycSession @relation(fields: [kycSessionId], references: [id])

  @@index([kycSessionId])
  @@map("webhook_log")
}

// ============================================
// Pricing Tiers (Volume-based pricing per client)
// ============================================

model PricingTier {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId          String   @map("client_id") @db.Uuid
  productId         String   @map("product_id")
  tierName          String   @map("tier_name") // e.g., 'Tier 1', 'Tier 2'
  minVolume         Int      @map("min_volume") // 0, 101, 501, etc.
  maxVolume         Int?     @map("max_volume") // 100, 500, NULL (unlimited)
  creditsPerSession Int      @map("credits_per_session") // e.g., 50 credits (10 credits = RM 1)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  client  Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@unique([clientId, productId, minVolume])
  @@index([clientId, productId])
  @@map("pricing_tier")
}

// ============================================
// Demo Webhook Storage (for demo page)
// ============================================

model DemoWebhook {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId    String   @map("session_id") @db.Uuid
  event        String   // e.g., 'kyc.session.completed'
  payload      Json     // Full webhook payload
  receivedAt   DateTime @default(now()) @map("received_at")

  @@index([sessionId])
  @@map("demo_webhook")
}

// ============================================
// Invoices
// ============================================

model Invoice {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId                String    @map("client_id") @db.Uuid
  invoiceNumber           String    @unique @map("invoice_number") // e.g., "INV-2026-01-001"

  // Billing period
  periodStart             DateTime  @map("period_start")
  periodEnd               DateTime  @map("period_end")

  // Payment terms
  dueDate                 DateTime  @map("due_date") @db.Date // generated_at + 14 days

  // Amounts (in credits)
  totalUsageCredits       Int       @map("total_usage_credits")
  previousBalanceCredits  Int       @default(0) @map("previous_balance_credits")
  creditBalanceAtGeneration Int     @map("credit_balance_at_generation")
  amountDueCredits        Int       @map("amount_due_credits")
  amountDueMyr            Decimal   @map("amount_due_myr") @db.Decimal(10, 2)

  // SST (8% tax on MYR amount)
  sstRate                 Decimal   @default(0.08) @map("sst_rate") @db.Decimal(5, 4) // 0.0800 = 8%
  sstAmountMyr            Decimal   @default(0) @map("sst_amount_myr") @db.Decimal(10, 2)
  totalWithSstMyr         Decimal   @default(0) @map("total_with_sst_myr") @db.Decimal(10, 2)

  // Payment tracking
  amountPaidCredits       Int       @default(0) @map("amount_paid_credits")
  amountPaidMyr           Decimal   @default(0) @map("amount_paid_myr") @db.Decimal(10, 2)

  // Storage
  s3Key                   String    @map("s3_key") // invoices/{client_id}/{invoice_id}.pdf

  // Superseded tracking
  supersededByInvoiceId   String?   @map("superseded_by_invoice_id") @db.Uuid

  // Metadata
  status                  String    @default("generated") // generated, partial, paid, superseded, void
  generatedAt             DateTime  @default(now()) @map("generated_at")
  generatedBy             String?   @map("generated_by") // NULL if auto-generated by cron

  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @default(now()) @updatedAt @map("updated_at")

  // Relations
  client              Client              @relation(fields: [clientId], references: [id])
  generatedByUser     User?               @relation("InvoiceGeneratedBy", fields: [generatedBy], references: [id])
  supersededByInvoice Invoice?            @relation("InvoiceSuperseded", fields: [supersededByInvoiceId], references: [id])
  supersededInvoices  Invoice[]           @relation("InvoiceSuperseded")
  lineItems           InvoiceLineItem[]
  referencedByLineItems InvoiceLineItem[] @relation("LineItemReference")
  payments            Payment[]

  @@index([clientId])
  @@index([periodStart, periodEnd])
  @@index([status])
  @@index([dueDate])
  @@map("invoice")
}

model InvoiceLineItem {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId             String   @map("invoice_id") @db.Uuid

  // Line item type
  lineType              String   @map("line_type") // 'usage' or 'previous_balance'

  // For usage lines
  productId             String?  @map("product_id") // 'true_identity' (NULL for previous_balance)
  tierName              String?  @map("tier_name") // 'Tier 1', 'Tier 2', or NULL for default
  sessionCount          Int?     @map("session_count") // Number of sessions (NULL for previous_balance)
  creditsPerSession     Int?     @map("credits_per_session") // Rate applied (NULL for previous_balance)

  // For previous_balance lines
  referenceInvoiceId    String?  @map("reference_invoice_id") @db.Uuid
  referenceInvoiceNumber String? @map("reference_invoice_number") // e.g., "INV-2026-01-001"

  // Common fields
  totalCredits          Int      @map("total_credits")
  totalMyr              Decimal  @map("total_myr") @db.Decimal(10, 2)

  createdAt             DateTime @default(now()) @map("created_at")

  // Relations
  invoice           Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  referenceInvoice  Invoice? @relation("LineItemReference", fields: [referenceInvoiceId], references: [id])

  @@index([invoiceId])
  @@index([lineType])
  @@map("invoice_line_item")
}

// ============================================
// Payments
// ============================================

model Payment {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  invoiceId        String   @map("invoice_id") @db.Uuid
  clientId         String   @map("client_id") @db.Uuid

  // Payment details
  amountCredits    Int      @map("amount_credits")
  amountMyr        Decimal  @map("amount_myr") @db.Decimal(10, 2)

  // SST (8% tax on MYR amount)
  sstRate          Decimal  @default(0.08) @map("sst_rate") @db.Decimal(5, 4) // 0.0800 = 8%
  sstAmountMyr     Decimal  @default(0) @map("sst_amount_myr") @db.Decimal(10, 2)
  totalWithSstMyr  Decimal  @default(0) @map("total_with_sst_myr") @db.Decimal(10, 2)

  // Payment info
  paymentDate      DateTime @map("payment_date") @db.Date
  paymentMethod    String?  @map("payment_method") // bank_transfer, fpx, cash
  paymentReference String?  @map("payment_reference") // transaction ID, cheque number

  // Receipt
  receiptNumber    String   @unique @map("receipt_number") // e.g., "RCP-2026-01-001"
  s3Key            String   @map("s3_key") // receipts/{client_id}/{payment_id}.pdf

  // Metadata
  recordedBy       String?  @map("recorded_by")
  notes            String?

  createdAt        DateTime @default(now()) @map("created_at")

  // Relations
  invoice        Invoice @relation(fields: [invoiceId], references: [id])
  client         Client  @relation(fields: [clientId], references: [id])
  recordedByUser User?   @relation("PaymentRecordedBy", fields: [recordedBy], references: [id])

  @@index([invoiceId])
  @@index([clientId])
  @@map("payment")
}
